#!/usr/bin/env bash
set -e

PWD=$(dirname "$0")
export PROJ_PATH=$(readlink -f "${PWD}/..")

BINARY_PATH="${PROJ_PATH}/bin"
source ${BINARY_PATH}/runtime_env_setup.sh

# Usage example:
# $ r2g \
# --top top \
# --rtl top.v \
# --out top.gds \
# --mhz 1000 \
# --x 150 \
# --y 150 # if not specified, then it is square\
# --flow all|syn|fp|pr \
# --gui \
# --sdc default.sdc
# #--config top.json
#

# Default values
DESIGN_TOP="top"
RTL_FILE="top.v"
GDS_FILE="top.gds"
SDC_FILE="${PROJ_PATH}/tools/default.sdc"
CLK_PORT_NAME="clock"
CLK_FREQ_MHZ=500
DIE_AREA="0 0 150 150" # always start with "0 0"
CORE_AREA="10 10 140 140"  # minus 10 for each line of DIE_AREA

RUN_SYNTHESIS=0
RUN_FLOORPLAN=0
RUN_PLACE_ROUTE=0
RUN_STA=0
# ENABLE_GUI=0  # default to 0 (disabled)
CONFIG_JSON="top.json"

# Function to print usage
print_usage() {
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  --top <design_top>       Design top module name (default: top)"
    echo "  --rtl <rtl_file>         RTL file(s) (default: top.v)"
    echo "  --out <gds_file>         Output GDS file (default: top.gds)"
    echo "  --mhz <freq_mhz>         Clock frequency in MHz (default: 500)"
    echo "  --x <die_x>              Die area X dimension (default: 150)"
    echo "  --y <die_y>              Die area Y dimension (default: 150)"
    echo "  --flow <flow>            Flow to run: all|syn|fp|pr (default: all)"
    # echo "  --gui                    Enable GUI (default: disabled)"
    # echo "  --config <config_json>   Configuration JSON file (default: top.json)"
}

# Process arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --top)
            DESIGN_TOP="$2"
            shift 2
            ;;
        --rtl)
            RTL_FILE="$2"
            shift 2
            ;;
        --out)
            GDS_FILE="$2"
            shift 2
            ;;
        --mhz)
            CLK_FREQ_MHZ="$2"
            shift 2
            ;;
        --x)
            DIE_X="$2"
            shift 2
            ;;
        --y)
            DIE_Y="$2"
            shift 2
            ;;
        --flow)
            case "$2" in
                all)
                    RUN_SYNTHESIS=1
                    RUN_FLOORPLAN=1
                    RUN_PLACE_ROUTE=1
                    ;;
                syn)
                    RUN_SYNTHESIS=1
                    RUN_FLOORPLAN=0
                    RUN_PLACE_ROUTE=0
                    ;;
                nosyn)
                    RUN_SYNTHESIS=0
                    RUN_FLOORPLAN=1
                    RUN_PLACE_ROUTE=1
                    ;;
                fp)
                    RUN_SYNTHESIS=1
                    RUN_FLOORPLAN=1
                    RUN_PLACE_ROUTE=0
                    ;;
                pr)
                    RUN_SYNTHESIS=1
                    RUN_FLOORPLAN=1
                    RUN_PLACE_ROUTE=1
                    ;;
                # sta)
                #     RUN_SYNTHESIS=0
                #     RUN_FLOORPLAN=0
                #     RUN_PLACE_ROUTE=0
                #     RUN_STA=1
                #     ;;
                *)
                    echo "Unknown flow: $2"
                    print_usage
                    exit 1
                    ;;
            esac
            shift 2
            ;;
        --gui)
            ENABLE_GUI=1
            shift
            ;;
        --sdc)
            SDC_FILE="$2"
            shift 2
            ;;
        --config)
            CONFIG_JSON="$2"
            shift 2
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            print_usage
            exit 1
            ;;
    esac
done

MARGIN=10
if [[ -n "${DIE_X:-}" ]] && [[ -n "${DIE_Y:-}" ]]; then
    DIE_AREA="0 0 $DIE_X $DIE_Y"
    CORE_AREA="$MARGIN $MARGIN $((DIE_X - $MARGIN)) $((DIE_Y - $MARGIN))"
fi

source ${PWD}/flow.sh
